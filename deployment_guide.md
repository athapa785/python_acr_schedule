# ACR Schedule Viewer Deployment Guide

This guide explains how to deploy the ACR Schedule Viewer application to work with an existing Apache server without requiring Apache configuration changes.

## Deployment Steps

### 1. Build the React Frontend

```bash
# Navigate to the frontend directory
cd frontend

# Install dependencies
npm install

# Build the React application
npm run build
```

### 2. Prepare the Django Backend

```bash
# Navigate to the backend directory
cd backend

# If you encounter proxy issues, set up SOCKS proxy environment variables
export HTTP_PROXY=socks5h://localhost:8080
export HTTPS_PROXY=socks5h://localhost:8080

# Install or update Python dependencies
pip install -r requirements.txt

# If you encounter "Missing dependencies for SOCKS support" error
# Make sure asgiref is installed
pip install asgiref==3.6.0

# Set the subdirectory path where the application is mounted
export DJANGO_FORCE_SCRIPT_NAME=/acr_schedule

# Collect static files
python manage.py collectstatic --noinput
```

### 3. Deploy with Existing Service File

The server is configured to run the Django application using Uvicorn on port 8004. Our application has been adapted to work with this configuration.

```ini
# The existing systemd service file
[Unit]
Description=ACR Schedule Web Application Service
Wants=local-fs.target network.target socks_proxy.service
After=local-fs.target network.target socks_proxy.service

[Install]
WantedBy=multi-user.target

[Service]
Type=simple
User=python_acr_schedule
Group=python_acr_schedule
WorkingDirectory=/var/www/python_acr_schedule/backend
ExecStart=/var/www/python_acr_schedule/backend/venv/bin/uvicorn --port=8004 --timeout-graceful-shutdown 5 'backend.asgi:application'
KillMode=process
PrivateTmp=true
StandardOutput=journal
Restart=on-failure
RestartSec=5s
```

The Django application will:
- Serve the React frontend when accessed directly
- Handle API requests at `/api/schedule/`
- Serve static files when needed

### 4. Update Environment Variables

For the application to work correctly with Apache's proxy configuration, you need to add the following environment variable to the service:

```ini
Environment=DJANGO_FORCE_SCRIPT_NAME=/acr_schedule
Environment=DJANGO_DEBUG=False
```

This tells Django that it's being served from the `/acr_schedule/` subdirectory, which is essential for proper URL generation.

### 5. Restart the Service

```bash
# Restart the existing service
sudo systemctl restart python_acr_schedule
```

## How It Works

The updated configuration allows Django and Apache to coexist without conflicts:

1. **Static Files**: Django will serve static files when Apache doesn't handle them
2. **API Endpoints**: Django handles all API requests at `/api/schedule/`
3. **React Frontend**: Django serves the React frontend for all other routes
4. **URL Prefix**: The `DJANGO_FORCE_SCRIPT_NAME` environment variable ensures all URLs generated by Django include the `/acr_schedule/` prefix

This approach ensures that:
- No Apache configuration changes are needed
- The existing service file continues to work
- The application functions correctly

## Troubleshooting

If you encounter any issues:

1. **Uvicorn Not Found**: If you get "command not found" when trying to run Uvicorn:
   ```bash
   pip install uvicorn==0.23.2
   ```

2. **Missing Dependencies**: If you get "No module named 'asgiref'" or similar errors:
   ```bash
   pip install asgiref==3.6.0
   ```

3. **SOCKS Proxy Issues**: If you encounter proxy-related errors:
   ```bash
   export HTTP_PROXY=socks5h://localhost:8080
   export HTTPS_PROXY=socks5h://localhost:8080
   ```

4. **503 Service Unavailable**: This usually means the Django application isn't running or Apache isn't correctly proxying to it. Check:
   - Is the Django service running? (`systemctl status python_acr_schedule`)
   - Can you access the application directly? (`curl http://localhost:8004/api/schedule/`)
   - Check if Apache is configured to proxy to the correct port (8004)
   - Verify the `DJANGO_FORCE_SCRIPT_NAME` environment variable is set to `/acr_schedule`

5. **Static Files Not Loading**: Make sure static files were collected properly and the paths in settings.py are correct.

6. **URLs Missing Prefix**: If URLs are missing the `/acr_schedule/` prefix, ensure the `DJANGO_FORCE_SCRIPT_NAME` environment variable is set correctly.

## Maintenance

When updating the application:

1. Pull the latest code
2. Rebuild the React frontend
3. Collect static files
4. Restart the service

## Running Locally for Testing

To run the application locally for testing:

```bash
# Navigate to the backend directory
cd backend

# Set the subdirectory path where the application is mounted
export DJANGO_FORCE_SCRIPT_NAME=/acr_schedule

# Run using Uvicorn (matches production)
./venv/bin/uvicorn --port=8004 --timeout-graceful-shutdown 5 'backend.asgi:application'

# Or run using Gunicorn (alternative)
./venv/bin/python -m gunicorn backend.wsgi:application --bind 127.0.0.1:8000
```

You can then access the application at http://localhost:8004/ (Uvicorn) or http://localhost:8000/ (Gunicorn)
